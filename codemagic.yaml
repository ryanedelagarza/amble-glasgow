workflows:
  ios-release:
    name: iOS Release
    max_build_duration: 120
    instance_type: mac_mini_m1
    environment:
      groups:
        - app_store_connect
      vars:
        XCODE_WORKSPACE: "ios/Runner.xcworkspace"
        XCODE_SCHEME: "Runner"
        BUNDLE_ID: "com.delagarza.scout"
      flutter: stable
      xcode: latest
      cocoapods: default
      ios_signing:
        distribution_type: app_store
        bundle_identifier: com.delagarza.scout
    
    scripts:
      - name: Set up iOS platform
        script: |
          # Generate iOS platform files
          flutter create --platforms=ios --org com.delagarza --project-name scout .
          
          # Update iOS deployment target to 14.0
          sed -i '' 's/platform :ios, '\''[0-9.]*'\''/platform :ios, '\''14.0'\''/' ios/Podfile
          
          # Also update in Xcode project
          sed -i '' 's/IPHONEOS_DEPLOYMENT_TARGET = [0-9.]*;/IPHONEOS_DEPLOYMENT_TARGET = 14.0;/g' ios/Runner.xcodeproj/project.pbxproj
          
          # Create Info.plist directly
          cat > ios/Runner/Info.plist << 'INFOPLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
          	<key>CFBundleDevelopmentRegion</key>
          	<string>$(DEVELOPMENT_LANGUAGE)</string>
          	<key>CFBundleDisplayName</key>
          	<string>Amble</string>
          	<key>CFBundleExecutable</key>
          	<string>$(EXECUTABLE_NAME)</string>
          	<key>CFBundleIdentifier</key>
          	<string>$(PRODUCT_BUNDLE_IDENTIFIER)</string>
          	<key>CFBundleInfoDictionaryVersion</key>
          	<string>6.0</string>
          	<key>CFBundleName</key>
          	<string>scout</string>
          	<key>CFBundlePackageType</key>
          	<string>APPL</string>
          	<key>CFBundleShortVersionString</key>
          	<string>$(FLUTTER_BUILD_NAME)</string>
          	<key>CFBundleSignature</key>
          	<string>????</string>
          	<key>CFBundleVersion</key>
          	<string>$(FLUTTER_BUILD_NUMBER)</string>
          	<key>LSRequiresIPhoneOS</key>
          	<true/>
          	<key>UILaunchStoryboardName</key>
          	<string>LaunchScreen</string>
          	<key>UIMainStoryboardFile</key>
          	<string>Main</string>
          	<key>UISupportedInterfaceOrientations</key>
          	<array>
          		<string>UIInterfaceOrientationPortrait</string>
          		<string>UIInterfaceOrientationLandscapeLeft</string>
          		<string>UIInterfaceOrientationLandscapeRight</string>
          	</array>
          	<key>UISupportedInterfaceOrientations~ipad</key>
          	<array>
          		<string>UIInterfaceOrientationPortrait</string>
          		<string>UIInterfaceOrientationPortraitUpsideDown</string>
          		<string>UIInterfaceOrientationLandscapeLeft</string>
          		<string>UIInterfaceOrientationLandscapeRight</string>
          	</array>
          	<key>UIViewControllerBasedStatusBarAppearance</key>
          	<false/>
          	<key>CADisableMinimumFrameDurationOnPhone</key>
          	<true/>
          	<key>UIApplicationSupportsIndirectInputEvents</key>
          	<true/>
          </dict>
          </plist>
          INFOPLIST
          
          # Get dependencies
          flutter pub get
      
      - name: Set up code signing
        script: |
          xcode-project use-profiles
          
          # Get the provisioning profile UUID
          PROFILE_PATH=$(ls ~/Library/MobileDevice/Provisioning\ Profiles/*.mobileprovision | head -1)
          PROFILE_UUID=$(grep -a -A 1 'UUID' "$PROFILE_PATH" | grep string | sed -e 's/<string>//' -e 's/<\/string>//' -e 's/^[ \t]*//')
          
          echo "Found provisioning profile UUID: $PROFILE_UUID"
          
          # Create export options plist
          cat > ios/ExportOptions.plist <<EXPORTPLIST
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
          	<key>method</key>
          	<string>app-store</string>
          	<key>teamID</key>
          	<string>3ZB62C422U</string>
          	<key>uploadSymbols</key>
          	<true/>
          	<key>compileBitcode</key>
          	<false/>
          	<key>provisioningProfiles</key>
          	<dict>
          		<key>com.delagarza.scout</key>
          		<string>$PROFILE_UUID</string>
          	</dict>
          </dict>
          </plist>
          EXPORTPLIST
          
          echo "Created ExportOptions.plist with profile: $PROFILE_UUID"
      
      - name: Build iOS app
        script: |
          # Build archive
          flutter build ipa --release --export-options-plist=ios/ExportOptions.plist
          
          # Verify IPA was created
          echo "=== Checking for IPA file ==="
          ls -lh build/ios/ipa/ || echo "IPA directory not found"
    
    artifacts:
      - build/ios/ipa/*.ipa
      - build/ios/archive/*.xcarchive
      - /tmp/xcodebuild_logs/*.log
    
    publishing:
      email:
        recipients:
          - ryan.e.delagarza@gmail.com
        notify:
          success: true
          failure: true
      app_store_connect:
        api_key: $APP_STORE_CONNECT_PRIVATE_KEY
        key_id: $APP_STORE_CONNECT_KEY_IDENTIFIER
        issuer_id: $APP_STORE_CONNECT_ISSUER_ID
        submit_to_testflight: true