workflows:
  ios-release:
    name: iOS Release
    max_build_duration: 120
    instance_type: mac_mini_m1
    environment:
      groups:
        - app_store_connect
      vars:
        XCODE_WORKSPACE: "ios/Runner.xcworkspace"
        XCODE_SCHEME: "Runner"
        BUNDLE_ID: "com.delagarza.scout"
      flutter: stable
      xcode: latest
      cocoapods: default
    
    scripts:
      - name: Set up iOS platform
        script: |
          # Generate iOS platform files
          flutter create --platforms=ios --org com.delagarza --project-name scout .
          
          # Create Info.plist directly
          cat > ios/Runner/Info.plist << 'INFOPLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
          	<key>CFBundleDevelopmentRegion</key>
          	<string>$(DEVELOPMENT_LANGUAGE)</string>
          	<key>CFBundleDisplayName</key>
          	<string>Amble</string>
          	<key>CFBundleExecutable</key>
          	<string>$(EXECUTABLE_NAME)</string>
          	<key>CFBundleIdentifier</key>
          	<string>$(PRODUCT_BUNDLE_IDENTIFIER)</string>
          	<key>CFBundleInfoDictionaryVersion</key>
          	<string>6.0</string>
          	<key>CFBundleName</key>
          	<string>scout</string>
          	<key>CFBundlePackageType</key>
          	<string>APPL</string>
          	<key>CFBundleShortVersionString</key>
          	<string>$(FLUTTER_BUILD_NAME)</string>
          	<key>CFBundleSignature</key>
          	<string>????</string>
          	<key>CFBundleVersion</key>
          	<string>$(FLUTTER_BUILD_NUMBER)</string>
          	<key>LSRequiresIPhoneOS</key>
          	<true/>
          	<key>UILaunchStoryboardName</key>
          	<string>LaunchScreen</string>
          	<key>UIMainStoryboardFile</key>
          	<string>Main</string>
          	<key>UISupportedInterfaceOrientations</key>
          	<array>
          		<string>UIInterfaceOrientationPortrait</string>
          		<string>UIInterfaceOrientationLandscapeLeft</string>
          		<string>UIInterfaceOrientationLandscapeRight</string>
          	</array>
          	<key>UISupportedInterfaceOrientations~ipad</key>
          	<array>
          		<string>UIInterfaceOrientationPortrait</string>
          		<string>UIInterfaceOrientationPortraitUpsideDown</string>
          		<string>UIInterfaceOrientationLandscapeLeft</string>
          		<string>UIInterfaceOrientationLandscapeRight</string>
          	</array>
          	<key>UIViewControllerBasedStatusBarAppearance</key>
          	<false/>
          	<key>CADisableMinimumFrameDurationOnPhone</key>
          	<true/>
          	<key>UIApplicationSupportsIndirectInputEvents</key>
          	<true/>
          </dict>
          </plist>
          INFOPLIST
          
          # Get dependencies
          flutter pub get
      
      - name: Set up code signing
        script: |
          xcode-project use-profiles
      
      - name: Build iOS app
        script: |
          flutter build ipa --release
    
    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
    
    publishing:
      email:
        recipients:
          - ryan.e.delagarza@gmail.com
      app_store_connect:
        api_key: $APP_STORE_CONNECT_PRIVATE_KEY
        key_id: $APP_STORE_CONNECT_KEY_IDENTIFIER
        issuer_id: $APP_STORE_CONNECT_ISSUER_ID
        submit_to_testflight: true